# æ™‚é–“åŒæ­¥ä¿®å¾©èªªæ˜

## ğŸ› å•é¡Œæè¿°

**ç”¨æˆ¶å ±å‘Šï¼š**
> å°ˆæ³¨æ™‚é–“ã€çŸ­ä¼‘æ¯ã€é•·ä¼‘æ¯æ™‚é–“æ²’æœ‰åŒæ­¥æ›´æ–°åˆ°ä¸»é é¢ï¼Œæ¯ç•¶æˆ‘æŒ‰é–‹å§‹éƒ½æœƒè·³åˆ° 25 åˆ†é˜

## ğŸ” å•é¡Œåˆ†æ

### æ ¹æœ¬åŸå› ï¼š

ç™¼ç¾äº†å…©å€‹å•é¡Œï¼š

1. **`switchMode()` ç¼ºå°‘ tick äº‹ä»¶**
   - ç•¶ç”¨æˆ¶åˆ‡æ›æ¨¡å¼ï¼ˆä¾‹å¦‚å¾å°ˆæ³¨åˆ‡åˆ°çŸ­ä¼‘æ¯ï¼‰æ™‚
   - é›–ç„¶å…§éƒ¨ `currentData.remainingSeconds` æ›´æ–°äº†
   - ä½†æ²’æœ‰ç™¼é€ `tickSubject.send(duration)` äº‹ä»¶
   - UI ä¾è³´ `tickPublisher` ä¾†æ›´æ–°é¡¯ç¤ºæ™‚é–“
   - çµæœï¼šUI é¡¯ç¤ºèˆŠæ™‚é–“

2. **`updateSettings()` åªåœ¨ ready ç‹€æ…‹æ›´æ–°**
   - å¦‚æœç”¨æˆ¶åœ¨ completed ç‹€æ…‹ä¿®æ”¹è¨­å®š
   - æ™‚é–“ä¸æœƒæ›´æ–°
   - ä¸‹æ¬¡å•Ÿå‹•æ™‚ä»ä½¿ç”¨èˆŠæ™‚é–“

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®å¾© 1: `switchMode()` æ·»åŠ  tick äº‹ä»¶

**ä¿®æ”¹æª”æ¡ˆï¼š** `TimerEngine.swift`

**ä¿®æ”¹å‰ï¼š**
```swift
func switchMode(to mode: TimerMode) {
    // ... å…¶ä»–ç¨‹å¼ç¢¼ ...

    // Publish state change
    stateSubject.send(.ready)

    // Auto-save
    saveState()
}
```

**ä¿®æ”¹å¾Œï¼š**
```swift
func switchMode(to mode: TimerMode) {
    // ... å…¶ä»–ç¨‹å¼ç¢¼ ...

    // Publish state change
    stateSubject.send(.ready)

    // Publish tick to update UI display time  â† æ–°å¢é€™è¡Œ
    tickSubject.send(duration)

    // Auto-save
    saveState()
}
```

### ä¿®å¾© 2: `updateSettings()` æ”¯æ´æ›´å¤šç‹€æ…‹

**ä¿®æ”¹å‰ï¼š**
```swift
// If timer is in ready state, update the remaining time
if currentData.state == .ready {
    let newDuration = timerSettings.duration(for: currentData.mode)
    // ... æ›´æ–°ç¨‹å¼ç¢¼ ...
}
```

**ä¿®æ”¹å¾Œï¼š**
```swift
// If timer is NOT running or paused, update the remaining time
if currentData.state == .ready || currentData.state == .completed {
    let newDuration = timerSettings.duration(for: currentData.mode)
    // ... æ›´æ–°ç¨‹å¼ç¢¼ ...

    // Publish state change (in case we moved from completed to ready)
    stateSubject.send(.ready)  â† æ–°å¢ï¼šç¢ºä¿ç‹€æ…‹æ­£ç¢º

    // Publish tick to update UI
    tickSubject.send(newDuration)
}
```

## ğŸ§ª æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: ä¿®æ”¹è¨­å®šå¾Œåˆ‡æ›æ¨¡å¼

**æ­¥é©Ÿï¼š**
1. æ‰“é–‹è¨­å®šï¼Œå°‡å°ˆæ³¨æ™‚é–“æ”¹ç‚º 30 åˆ†é˜
2. ä¿å­˜è¨­å®š
3. è¿”å›ä¸»ç•«é¢
4. âœ… ç¢ºèªé¡¯ç¤º 30:00ï¼ˆè€Œä¸æ˜¯ 25:00ï¼‰
5. åˆ‡æ›åˆ°çŸ­ä¼‘æ¯
6. âœ… ç¢ºèªé¡¯ç¤ºæ­£ç¢ºçš„çŸ­ä¼‘æ¯æ™‚é–“

**é æœŸçµæœï¼š** æ‰€æœ‰æ¨¡å¼é¡¯ç¤ºæ­£ç¢ºçš„è‡ªå®šç¾©æ™‚é–“

### å ´æ™¯ 2: å®Œæˆç‹€æ…‹ä¿®æ”¹è¨­å®š

**æ­¥é©Ÿï¼š**
1. é–‹å§‹ä¸€å€‹å°ˆæ³¨è¨ˆæ™‚
2. ç­‰å¾…å®Œæˆï¼ˆæˆ–å¿«è½‰æ¸¬è©¦ï¼‰
3. è¨ˆæ™‚å™¨é¡¯ç¤ºã€Œå·²å®Œæˆã€
4. æ‰“é–‹è¨­å®šï¼Œå°‡å°ˆæ³¨æ™‚é–“æ”¹ç‚º 20 åˆ†é˜
5. ä¿å­˜è¨­å®š
6. è¿”å›ä¸»ç•«é¢
7. âœ… ç¢ºèªç‹€æ…‹è®Šç‚ºã€Œå°±ç·’ã€
8. âœ… ç¢ºèªé¡¯ç¤º 20:00

**é æœŸçµæœï¼š** å®Œæˆç‹€æ…‹ä¸‹ä¿®æ”¹è¨­å®šä¹Ÿèƒ½æ­£ç¢ºæ›´æ–°

### å ´æ™¯ 3: è‡ªå‹•åˆ‡æ›ä¼‘æ¯æ™‚é–“

**æ­¥é©Ÿï¼š**
1. è¨­å®šå°ˆæ³¨æ™‚é–“ç‚º 30 åˆ†é˜
2. è¨­å®šçŸ­ä¼‘æ¯ç‚º 8 åˆ†é˜
3. é¸æ“‡ã€ŒçŸ­ä¼‘æ¯ã€æ¨¡å¼
4. é–‹å§‹å°ˆæ³¨ä¸¦ç­‰å¾…å®Œæˆ
5. âœ… ç¢ºèªè‡ªå‹•åˆ‡æ›åˆ°çŸ­ä¼‘æ¯
6. âœ… ç¢ºèªé¡¯ç¤º 08:00ï¼ˆè€Œä¸æ˜¯é è¨­çš„ 05:00ï¼‰

**é æœŸçµæœï¼š** è‡ªå‹•åˆ‡æ›ä½¿ç”¨è‡ªå®šç¾©æ™‚é–“

### å ´æ™¯ 4: é‹è¡Œä¸­ä¸å—å½±éŸ¿

**æ­¥é©Ÿï¼š**
1. é–‹å§‹å°ˆæ³¨è¨ˆæ™‚ï¼ˆ25 åˆ†é˜ï¼‰
2. è¨ˆæ™‚å™¨é‹è¡Œåˆ° 20:00
3. æ‰“é–‹è¨­å®šï¼Œå°‡å°ˆæ³¨æ™‚é–“æ”¹ç‚º 30 åˆ†é˜
4. ä¿å­˜è¨­å®š
5. è¿”å›ä¸»ç•«é¢
6. âœ… ç¢ºèªä»é¡¯ç¤º 20:00ï¼ˆä¸å—å½±éŸ¿ï¼‰
7. ç­‰å¾…å®Œæˆæˆ–é‡ç½®
8. âœ… ç¢ºèªä¸‹æ¬¡é–‹å§‹æ™‚ä½¿ç”¨ 30 åˆ†é˜

**é æœŸçµæœï¼š** é‹è¡Œä¸­çš„è¨ˆæ™‚å™¨ä¸å—è¨­å®šè®Šæ›´å½±éŸ¿

## ğŸ“Š æŠ€è¡“ç´°ç¯€

### Combine Publisher æµç¨‹

```
User Changes Settings
    â†“
updateSettings(newSettings)
    â†“
timerSettings = newSettings (æ›´æ–°å…§éƒ¨è¨­å®š)
    â†“
persistence.saveTimerSettings() (ä¿å­˜åˆ° UserDefaults)
    â†“
æ›´æ–° currentData.remainingSeconds
    â†“
stateSubject.send(.ready) (ç™¼å¸ƒç‹€æ…‹è®Šæ›´)
    â†“
tickSubject.send(newDuration) (ç™¼å¸ƒ tick äº‹ä»¶) â† é—œéµï¼
    â†“
TimerViewModel è¨‚é–± tickPublisher
    â†“
displayTime = formatTime(remainingSeconds)
    â†“
UI æ›´æ–°é¡¯ç¤º
```

### ç‚ºä»€éº¼éœ€è¦ tick äº‹ä»¶ï¼Ÿ

TimerViewModel é€šéè¨‚é–± `tickPublisher` ä¾†æ›´æ–° UIï¼š

```swift
// TimerViewModel.swift
timerEngine.tickPublisher
    .receive(on: DispatchQueue.main)
    .sink { [weak self] remainingSeconds in
        self?.displayTime = Self.formatTime(remainingSeconds)
    }
    .store(in: &cancellables)
```

å¦‚æœä¸ç™¼é€ tick äº‹ä»¶ï¼Œé›–ç„¶ `currentData.remainingSeconds` æ›´æ–°äº†ï¼Œä½† UI ä¸æœƒæ”¶åˆ°é€šçŸ¥ï¼Œå°è‡´é¡¯ç¤ºæ™‚é–“ä¸åŒæ­¥ã€‚

## ğŸ¯ ä¿®å¾©é©—è­‰

### ç·¨è­¯ç‹€æ…‹ï¼š
```
âœ… BUILD SUCCEEDED
```

### æ¸¬è©¦æ¸…å–®ï¼š
- [ ] ä¿®æ”¹å°ˆæ³¨æ™‚é–“ï¼Œç¢ºèªä¸»é é¢åŒæ­¥
- [ ] ä¿®æ”¹çŸ­ä¼‘æ¯æ™‚é–“ï¼Œåˆ‡æ›æ¨¡å¼ç¢ºèªåŒæ­¥
- [ ] ä¿®æ”¹é•·ä¼‘æ¯æ™‚é–“ï¼Œåˆ‡æ›æ¨¡å¼ç¢ºèªåŒæ­¥
- [ ] å®Œæˆç‹€æ…‹ä¸‹ä¿®æ”¹è¨­å®šï¼Œç¢ºèªæ›´æ–°
- [ ] è‡ªå‹•åˆ‡æ›ä¼‘æ¯æ™‚ä½¿ç”¨è‡ªå®šç¾©æ™‚é–“
- [ ] é‹è¡Œä¸­ä¿®æ”¹è¨­å®šä¸å½±éŸ¿ç•¶å‰è¨ˆæ™‚
- [ ] é‡å•Ÿ App ç¢ºèªè¨­å®šä¿ç•™

## ğŸ“ ç›¸é—œæª”æ¡ˆ

**ä¿®æ”¹æª”æ¡ˆï¼š**
- `TimerEngine.swift` - ä¿®å¾© `switchMode()` å’Œ `updateSettings()`

**å½±éŸ¿çš„æ–¹æ³•ï¼š**
1. `switchMode(to:)` - æ·»åŠ  tick äº‹ä»¶ç™¼å¸ƒ
2. `updateSettings(_:)` - æ”¯æ´ completed ç‹€æ…‹ï¼Œæ·»åŠ ç‹€æ…‹ç™¼å¸ƒ

## ğŸš€ éƒ¨ç½²å»ºè­°

1. **ç«‹å³æ¸¬è©¦**ï¼šåœ¨ Xcode ä¸­é‹è¡Œä¸¦æ¸¬è©¦æ‰€æœ‰å ´æ™¯
2. **é‡é»æ¸¬è©¦**ï¼šä¿®æ”¹è¨­å®šå¾Œåˆ‡æ›æ¨¡å¼
3. **é‚Šç•Œæ¸¬è©¦**ï¼šåœ¨ä¸åŒç‹€æ…‹ä¸‹ä¿®æ”¹è¨­å®š

## ğŸ’¡ å­¸ç¿’é‡é»

### Reactive Programming çš„é‡è¦æ€§

åœ¨ Reactive æ¶æ§‹ä¸­ï¼Œæ•¸æ“šæ›´æ–°å¿…é ˆé€šéäº‹ä»¶é€šçŸ¥ï¼š

1. **æ•¸æ“šå±¤æ›´æ–°** - æ›´æ–°å…§éƒ¨ç‹€æ…‹
2. **äº‹ä»¶ç™¼å¸ƒ** - ç™¼é€ Publisher äº‹ä»¶
3. **UI è¨‚é–±éŸ¿æ‡‰** - UI æ”¶åˆ°äº‹ä»¶ä¸¦æ›´æ–°

ç¼ºå°‘ä»»ä½•ä¸€æ­¥éƒ½æœƒå°è‡´æ•¸æ“šä¸åŒæ­¥ï¼

### ç‹€æ…‹ç®¡ç†çš„å®Œæ•´æ€§

ä¿®æ”¹æ•¸æ“šæ™‚è¦è€ƒæ…®ï¼š
1. âœ… å…§éƒ¨ç‹€æ…‹æ›´æ–°
2. âœ… ç‹€æ…‹äº‹ä»¶ç™¼å¸ƒ
3. âœ… tick äº‹ä»¶ç™¼å¸ƒï¼ˆå°æ–¼æ™‚é–“ç›¸é—œï¼‰
4. âœ… æŒä¹…åŒ–ä¿å­˜

## âœ¨ ç¸½çµ

é€™æ¬¡ä¿®å¾©è§£æ±ºäº†æ™‚é–“é¡¯ç¤ºä¸åŒæ­¥çš„å•é¡Œï¼š

âœ… **ä¿®å¾© `switchMode()`** - åˆ‡æ›æ¨¡å¼æ™‚æ­£ç¢ºæ›´æ–° UI
âœ… **æ”¹é€² `updateSettings()`** - æ›´å¤šç‹€æ…‹ä¸‹éƒ½èƒ½æ­£ç¢ºæ›´æ–°
âœ… **å®Œå–„äº‹ä»¶ç™¼å¸ƒ** - ç¢ºä¿ UI åŠæ™‚éŸ¿æ‡‰æ•¸æ“šè®ŠåŒ–

ç¾åœ¨ç”¨æˆ¶ä¿®æ”¹æ™‚é–“è¨­å®šå¾Œï¼Œä¸»é é¢æœƒç«‹å³åŒæ­¥é¡¯ç¤ºæ­£ç¢ºçš„æ™‚é–“ï¼ğŸ‰
